# Контроль температуры удаленных объектов

Все знакомы с проблемами ЖКХ в потрепанных жилых фондах. Мой дом не исключение. Зимой холодно и при отключениях воды завоздушиваются стояки ГВС. И в том и другом случае достаточно сложно доказывать УК, что температуры не соответствуют нормам. Особенно отопления.

Для контроля решено было использовать [4-х канальное реле Modkam](https://modkam.ru/2019/11/19/rele-zigbee-v-podrozetnik/), которое существует в формате 4-х канального датчика температуры. Устройство на базе универсально прошивки для zigbee устройств [PTVO](https://ptvo.info/zigbee-configurable-firmware-features/). Купил я его [здесь](https://t.me/zigberu). Устройство доставило мне массу проблем: то его не спаришь, то оно отваливается. Рекомендации вендора не помогали и я забросил проект в долгий ящик.

После публикации статьи о [навыке Алисы для умного дома Яндекс](https://github.com/tsurkan-av/SLS/blob/main/AliceSkills/funtik/Readme.md), который я разработал еще в начале 2023 года, один из пользователей отметил, что пользуется навыком [WQTT](https://www.wqtt.ru/). Я попробовал навык в работе. И, там же, в документации, наткнулся на проект [ESP Easy](https://letscontrolit.com/wiki/index.php/ESPEasy) - это универсальная прошивка, но для устройств на базе ESP.

Далее: сенсор - это один сенсор DS18B20, датчик - это группа сенсоров.

В итоге, на базе ESP получил решение, которое умеет:

- собирать данные с 6-ти сенсоров типа DS18B20, подключенных по витой паре на шлейфе до 25 метров
- отправлять данные на [SLS](https://github.com/slsys/Gateway) и [mqtt](https://www.wqtt.ru/) и далее в Алису для сбора исторических данных

Let's begin

## Железо

В проекте были использованы:

- [ESP-32S на отладочной плате DEVKIT v1](https://megabonus.com/y/8EwzA)
- сенсоры [DS18B20](https://megabonus.com/y/19urt)
- контроллер умного дома [SLS](https://github.com/slsys/Gateway)

Сенсоры подключены к ESP по [классической схеме](https://www.letscontrolit.com/wiki/index.php?title=Dallas_DS18b20) с подтягивающим резистором 4k7 двух-парным кабелем типа витая пара. По одной паре питание, по другой - сигнал. Питание всей схемы от источника +5v - обычный USB-зарядник. Сигнал на GPIO-17.

Сенсоры крепил к стоякам через термоинтерфейс с очисткой от краски. Где-то на изоленту, где-то на кабельные стяжки.

## Настройка ESP 

По [прошивке ESP](https://espeasy.readthedocs.io/en/latest/Reference/Flashing.html) достаточно много материала в сети, в том числе и в рунете. Поэтому останавливаться на этом не будем.

### Настройка сенсоров

Сенсоров подключаются через плагин [Environment - 1-Wire Temperature](https://espeasy.readthedocs.io/en/latest/Plugin/P004.html). Данный плагин поддерживает до 4-х сенсоров и позволяет передавать данные на контроллер одним пакетом или показание каждого сенсора отдельными пакетами. Правильно подключенные сенсоры прошивка определяет и их можно выбирать из списка.
ID конкретных сенсоров можно определять как самой ESPEasy, подключая их по одному или изменяя их температуру и считывая показания в прошивке, так и с помощью различных тестеров типа [GM328](https://megabonus.com/y/siMOg).

Для добавления датчиков переходим на вкладку `Devices`, нажимаем кнопку `Add`, заполняем:

- `Device` - выбрать плагин `Environment - 1-Wire Temperature`
- `Name` - желаемое имя. Поскольку плагин поддерживает до 4 сенсоров, я распределил их по назначению: 4 на отопление и 2 на ГВС
- `Enabled` - включить обработку датчика
- `GPIO ← TX` - pin, к которому подключены сенсоры DS18B20
- `Number Output Values` - количество сенсоров на данном плагине. В моем случае 4 - `Quad` и 2 - `Dual`
- `Single event with all values` - выкл - отдельное событие по каждому сенсору; вкл - значения всех сенсоры в одном событии
- `Send to Controller` - отправка на контроллер умного дома, настроенный на первой позиции на вкладке [Controllers](https://espeasy.readthedocs.io/en/latest/Controller/_Controller.html). Например mqtt брокер.
- `Interval` - желаемый интервал обработки в сек.

Нажимаем кнопку `Submit`, после чего подгружаются датчики и их можно прописать в полях `Device Address 1-4`. Также, если на одном пине только один датчик, можно включить опцию `Auto Select Sensor` для автоматического определения подключенного сенсора.

В разделе `Values` можно настроить:

- `Name` - имя сенсора
- `Formula` - пересчет значения. Например, для калибровки или для приведения ед. измерения.
- `Stats` - сохранять статистику. ESPEasy может хранить до 64 сэмплов на значение и строить графики, считать различные агрегатные функции: сумма, среднее, минимальное, максимальное и т.п.
- `Decimals` - количество знаков после запятой в передаваемом значении

В итоге получаем такой датчик:

![](/AliceSkills/wqtt/img/plugin1wire.png)

![](/AliceSkills/wqtt/img/plugin1wire2.png)
